<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= csrfToken %>">
    <title>My Profile - SACCO</title>
    <link rel="stylesheet" href="/css/design-system.css">
</head>

<body>
    <%- include('../layouts/member-header') %>

        <div class="container-xl">

            <!-- Page Header -->
            <div class="page-header">
                <div class="accent-line"></div>
                <h1 class="page-title">My Profile</h1>
                <p class="page-subtitle">Manage your personal information and documents</p>
            </div>

            <!-- Profile Information -->
            <div class="grid grid-cols-2 gap-6 mb-12">
                <div class="card">
                    <h2 class="section-title mb-6">Personal Information</h2>

                    <div class="space-y-4">
                        <div>
                            <p class="text-meta">Full Name</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= user.full_name %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Email Address</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= user.email %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Phone Number</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= user.phone_number %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Member Since</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= new Date(user.created_at).toLocaleDateString() %>
                            </p>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <button id="editProfileBtn" class="btn-secondary">Edit Profile</button>
                    </div>
                </div>

                <!-- Document Upload -->
                <div class="card">
                    <h2 class="section-title mb-6">Identity Documents</h2>

                    <div class="alert alert-warning mb-6">
                        <p style="margin: 0;">Please upload both front and back of your ID for verification.</p>
                    </div>

                    <!-- ID Front Upload -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-weight: 600; margin-bottom: 1rem;">ID Front</h3>
                        <% const idFront=documents.find(d=> d.document_type === 'id_front');
                            %>
                            <% if (!idFront || idFront.status==='rejected' ) { %>
                                <form class="document-upload-form" data-document-type="id_front"
                                    enctype="multipart/form-data">
                                    <div class="form-group">
                                        <input type="file" name="document" accept="image/*,application/pdf" required>
                                    </div>
                                    <button type="submit" class="btn-primary">Upload ID Front</button>
                                </form>
                                <% if (idFront && idFront.rejection_reason) { %>
                                    <p style="color: #EF4444; font-size: 0.875rem; margin-top: 0.5rem;">
                                        Previous rejection: <%= idFront.rejection_reason %>
                                    </p>
                                    <% } %>
                                        <% } else { %>
                                            <div style="padding: 1rem; background: #FAFAFA; border: 1px solid #E5E5E5;">
                                                <div
                                                    style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <p style="font-weight: 600; color: #000000;">Status:
                                                            <% if (idFront.status==='approved' ) { %>
                                                                <span style="color: #10B981;">Approved</span>
                                                                <% } else if (idFront.status==='in_review' ) { %>
                                                                    <span style="color: #F59E0B;">In Review</span>
                                                                    <% } else { %>
                                                                        <span style="color: #6B7280;">Pending</span>
                                                                        <% } %>
                                                        </p>
                                                        <p class="text-meta">Uploaded <%= new
                                                                Date(idFront.uploaded_at).toLocaleDateString() %>
                                                        </p>
                                                    </div>
                                                    <% if (idFront.status==='approved' ) { %>
                                                        <span
                                                            style="padding: 0.5rem 1rem; background: #10B981; color: #FFFFFF; border-radius: 4px;">✓</span>
                                                        <% } %>
                                                </div>
                                            </div>
                                            <% } %>
                    </div>

                    <!-- ID Back Upload -->
                    <div>
                        <h3 style="font-weight: 600; margin-bottom: 1rem;">ID Back</h3>
                        <% const idBack=documents.find(d=> d.document_type === 'id_back');
                            %>
                            <% if (!idBack || idBack.status==='rejected' ) { %>
                                <form class="document-upload-form" data-document-type="id_back"
                                    enctype="multipart/form-data">
                                    <div class="form-group">
                                        <input type="file" name="document" accept="image/*,application/pdf" required>
                                    </div>
                                    <button type="submit" class="btn-primary">Upload ID Back</button>
                                </form>
                                <% if (idBack && idBack.rejection_reason) { %>
                                    <p style="color: #EF4444; font-size: 0.875rem; margin-top: 0.5rem;">
                                        Previous rejection: <%= idBack.rejection_reason %>
                                    </p>
                                    <% } %>
                                        <% } else { %>
                                            <div style="padding: 1rem; background: #FAFAFA; border: 1px solid #E5E5E5;">
                                                <div
                                                    style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <p style="font-weight: 600; color: #000000;">Status:
                                                            <% if (idBack.status==='approved' ) { %>
                                                                <span style="color: #10B981;">Approved</span>
                                                                <% } else if (idBack.status==='in_review' ) { %>
                                                                    <span style="color: #F59E0B;">In Review</span>
                                                                    <% } else { %>
                                                                        <span style="color: #6B7280;">Pending</span>
                                                                        <% } %>
                                                        </p>
                                                        <p class="text-meta">Uploaded <%= new
                                                                Date(idBack.uploaded_at).toLocaleDateString() %>
                                                        </p>
                                                    </div>
                                                    <% if (idBack.status==='approved' ) { %>
                                                        <span
                                                            style="padding: 0.5rem 1rem; background: #10B981; color: #FFFFFF; border-radius: 4px;">✓</span>
                                                        <% } %>
                                                </div>
                                            </div>
                                            <% } %>
                    </div>
                </div>
            </div>

            <!-- Member Profile Form -->
            <div class="card mb-12">
                <h2 class="section-title mb-6">Member Profile Form</h2>

                <% if (profileForm) { %>
                    <div class="alert alert-info mb-6">
                        <p style="margin: 0;">
                            <strong>Form Submitted:</strong> This form has been locked. Only admins can make changes.
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <p class="text-meta">National ID Number</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= profileForm.national_id %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Date of Birth</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= new Date(profileForm.date_of_birth).toLocaleDateString() %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Address</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= profileForm.address %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Occupation</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= profileForm.occupation %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Next of Kin</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= profileForm.next_of_kin_name %>
                            </p>
                        </div>
                        <div>
                            <p class="text-meta">Next of Kin Phone</p>
                            <p style="font-weight: 600; color: #000000;">
                                <%= profileForm.next_of_kin_phone %>
                            </p>
                        </div>
                    </div>
                    <% } else { %>
                        <div class="alert alert-warning mb-6">
                            <p style="margin: 0;">
                                <strong>Important:</strong> This form can only be filled once. Please ensure all
                                information is correct before submitting.
                            </p>
                        </div>

                        <form id="profileFormSubmit" class="space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label for="nationalId">National ID Number</label>
                                    <input type="text" id="nationalId" name="national_id" required>
                                </div>

                                <div class="form-group">
                                    <label for="dateOfBirth">Date of Birth</label>
                                    <input type="date" id="dateOfBirth" name="date_of_birth" required>
                                </div>

                                <div class="form-group">
                                    <label for="address">Residential Address</label>
                                    <input type="text" id="address" name="address" required>
                                </div>

                                <div class="form-group">
                                    <label for="occupation">Occupation</label>
                                    <input type="text" id="occupation" name="occupation" required>
                                </div>

                                <div class="form-group">
                                    <label for="nextOfKinName">Next of Kin Name</label>
                                    <input type="text" id="nextOfKinName" name="next_of_kin_name" required>
                                </div>

                                <div class="form-group">
                                    <label for="nextOfKinPhone">Next of Kin Phone</label>
                                    <input type="tel" id="nextOfKinPhone" name="next_of_kin_phone" required>
                                </div>
                            </div>

                            <button type="submit" class="btn-primary">Submit Profile Form</button>
                        </form>
                        <% } %>
            </div>

            <!-- Guarantor Opt-In Section -->
            <div class="card mb-12">
                <h2 class="section-title mb-6">Guarantor Settings</h2>

                <div class="alert alert-info mb-6">
                    <p style="margin: 0;">
                        <strong>Become a Guarantor:</strong> Opt-in to be available as a guarantor for other members.
                        You can specify how many shares you're willing to pledge.
                    </p>
                </div>

                <form id="guarantorSettingsForm" style="display: grid; gap: 1.5rem;">
                    <div style="padding: 1.5rem; background: #FAFAFA; border: 2px solid #E5E5E5;">
                        <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer;">
                            <input
                                type="checkbox"
                                id="canBeGuarantor"
                                name="can_be_guarantor"
                                <%= user.can_be_guarantor ? 'checked' : '' %>
                                style="width: 24px; height: 24px; cursor: pointer;"
                            >
                            <div>
                                <p style="font-weight: 600; font-size: 1.125rem; margin: 0;">Available as Guarantor</p>
                                <p class="text-meta" style="margin: 0;">
                                    Allow other members to select you as a guarantor for their loans
                                </p>
                            </div>
                        </label>
                    </div>

                    <div id="guarantorDetailsSection" style="<%= user.can_be_guarantor ? '' : 'display: none;' %>">
                        <div class="form-group">
                            <label for="maxShares" style="font-weight: 600;">Maximum Shares to Guarantee</label>
                            <input
                                type="number"
                                id="maxShares"
                                name="max_shares_to_guarantee"
                                min="0"
                                max="100"
                                value="<%= user.max_shares_to_guarantee || 0 %>"
                                class="form-input"
                                style="border: 2px solid #000; font-size: 1.125rem; font-weight: 600;"
                            >
                            <p class="text-meta" style="margin-top: 0.5rem;">
                                Each share = KSh 1,000. Example: 5 shares = KSh 5,000 guarantee capacity
                            </p>
                        </div>

                        <div style="padding: 1.5rem; background: #FEF2F2; border: 2px solid #E5E5E5;">
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">How Guarantor System Works</h4>
                            <ul class="text-meta" style="margin: 0; padding-left: 1.5rem;">
                                <li>When a member needs a guarantor, you'll receive a request notification</li>
                                <li>You can approve or decline the request</li>
                                <li>You can edit the number of shares you're willing to pledge</li>
                                <li>Your shares are pledged only when you approve the request</li>
                                <li>Shares are released when the loan is fully repaid</li>
                            </ul>
                        </div>
                    </div>

                    <button
                        type="submit"
                        class="btn-primary"
                        style="background: #000; color: #FFF; border: 2px solid #000; padding: 1rem; font-size: 1.125rem; font-weight: 600;"
                    >
                        Save Guarantor Settings
                    </button>
                </form>
            </div>

        </div>



        <script src="/js/profile.js"></script>
        <script>
            // Guarantor settings toggle
            document.getElementById('canBeGuarantor').addEventListener('change', function() {
                const detailsSection = document.getElementById('guarantorDetailsSection');
                if (this.checked) {
                    detailsSection.style.display = 'block';
                } else {
                    detailsSection.style.display = 'none';
                    document.getElementById('maxShares').value = 0;
                }
            });

            // Guarantor settings form submission
            document.getElementById('guarantorSettingsForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const canBeGuarantor = document.getElementById('canBeGuarantor').checked;
                const maxShares = parseInt(document.getElementById('maxShares').value) || 0;

                if (canBeGuarantor && maxShares <= 0) {
                    alert('Please specify how many shares you are willing to guarantee (minimum 1)');
                    return;
                }

                try {
                    const response = await fetch('/profile/guarantor-settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        },
                        body: JSON.stringify({
                            can_be_guarantor: canBeGuarantor,
                            max_shares_to_guarantee: maxShares
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Guarantor settings updated successfully!');
                        window.location.reload();
                    } else {
                        alert(data.error || 'Failed to update guarantor settings');
                    }
                } catch (error) {
                    console.error('Guarantor settings error:', error);
                    alert('Failed to update guarantor settings. Please try again.');
                }
            });
        </script>
</body>

</html>