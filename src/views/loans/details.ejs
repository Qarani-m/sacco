<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - SACCO</title>
    <link rel="stylesheet" href="/css/design-system.css">
</head>
<body>
    <%- include('../layouts/member-header') %>
    
    <div class="container-xl">
        <!-- Page Header -->
        <div class="page-header">
            <div class="accent-line"></div>
            <h1 class="page-title">Loan Details</h1>
            <p class="page-subtitle">Loan #<%= loan.id.substring(0, 8) %></p>
        </div>

        <!-- Loan Status Banner -->
        <div class="card mb-6" style="background: <%= loan.status === 'active' ? '#F0FDF4' : loan.status === 'pending' ? '#FEF2F2' : '#FAFAFA' %>; border-left: 4px solid <%= loan.status === 'active' ? '#000' : loan.status === 'pending' ? '#EF4444' : '#9CA3AF' %>;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
                        Status: <span style="text-transform: uppercase;"><%= loan.status %></span>
                    </h3>
                    <p class="text-secondary" style="margin: 0;">
                        <% if (loan.status === 'pending') { %>
                            Your loan request is awaiting admin approval
                        <% } else if (loan.status === 'active') { %>
                            Your loan has been approved and is active
                        <% } else if (loan.status === 'paid') { %>
                            This loan has been fully repaid
                        <% } else if (loan.status === 'rejected') { %>
                            This loan request was rejected
                        <% } %>
                    </p>
                </div>
                <% if (loan.status === 'pending') { %>
                <button onclick="cancelLoan()" class="btn-secondary">Cancel Request</button>
                <% } %>
            </div>
        </div>

        <!-- Loan Information -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="card">
                <h3 class="small-title" style="margin-bottom: 1.5rem;">üí∞ Loan Information</h3>
                <div style="display: grid; gap: 1rem;">
                    <div style="padding: 1rem; background: #FAFAFA; border: 1px solid #E5E5E5; border-radius: 4px;">
                        <p class="text-meta">Requested Amount</p>
                        <p style="font-size: 1.5rem; font-weight: 600; color: #000;">KSh <%= loan.requested_amount.toLocaleString() %></p>
                    </div>
                    <% if (loan.approved_amount) { %>
                    <div style="padding: 1rem; background: #F0FDF4; border: 1px solid #D1FAE5; border-radius: 4px;">
                        <p class="text-meta">Approved Amount</p>
                        <p style="font-size: 1.5rem; font-weight: 600; color: #000;">KSh <%= loan.approved_amount.toLocaleString() %></p>
                    </div>
                    <% } %>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-meta">Interest Rate</p>
                            <p style="font-weight: 600;"><%= loan.interest_rate %>% per month</p>
                        </div>
                        <div>
                            <p class="text-meta">Repayment Period</p>
                            <p style="font-weight: 600;"><%= loan.repayment_months %> months</p>
                        </div>
                    </div>
                    <% if (loan.balance_remaining) { %>
                    <div style="padding: 1rem; background: #FEF2F2; border: 1px solid #FECACA; border-radius: 4px;">
                        <p class="text-meta">Balance Remaining</p>
                        <p style="font-size: 1.5rem; font-weight: 600; color: #000;">KSh <%= loan.balance_remaining.toLocaleString() %></p>
                    </div>
                    <% } %>
                </div>
            </div>

            <div class="card">
                <h3 class="small-title" style="margin-bottom: 1.5rem;">üìÖ Important Dates</h3>
                <div style="display: grid; gap: 1rem;">
                    <div style="padding: 1rem; background: #FAFAFA; border: 1px solid #E5E5E5; border-radius: 4px;">
                        <p class="text-meta">Request Date</p>
                        <p style="font-weight: 600;"><%= new Date(loan.created_at).toLocaleDateString() %></p>
                    </div>
                    <% if (loan.approved_at) { %>
                    <div style="padding: 1rem; background: #F0FDF4; border: 1px solid #D1FAE5; border-radius: 4px;">
                        <p class="text-meta">Approval Date</p>
                        <p style="font-weight: 600;"><%= new Date(loan.approved_at).toLocaleDateString() %></p>
                    </div>
                    <% } %>
                    <% if (loan.due_date) { %>
                    <div style="padding: 1rem; background: #FEF2F2; border: 1px solid #FECACA; border-radius: 4px;">
                        <p class="text-meta">Due Date</p>
                        <p style="font-weight: 600;"><%= new Date(loan.due_date).toLocaleDateString() %></p>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Guarantors -->
        <% if (guarantors && guarantors.length > 0) { %>
        <div class="card mb-6">
            <h3 class="small-title" style="margin-bottom: 1.5rem;">ü§ù Guarantors (<%= guarantors.length %>)</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Shares Pledged</th>
                        <th>Amount Covered</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <% guarantors.forEach(g => { %>
                    <tr>
                        <td><%= g.guarantor_name %></td>
                        <td><%= g.shares_pledged %> shares</td>
                        <td>KSh <%= g.amount_covered.toLocaleString() %></td>
                        <td>
                            <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">
                                <%= g.status %>
                            </span>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        <% } %>

        <!-- Repayment Schedule -->
        <% if (schedule) { %>
        <div class="card mb-6">
            <h3 class="small-title" style="margin-bottom: 1.5rem;">üìä Repayment Schedule</h3>
            <div style="padding: 1rem; background: #FAFAFA; border: 1px solid #E5E5E5; margin-bottom: 1.5rem; border-radius: 4px;">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <p class="text-meta">Total Amount</p>
                        <p style="font-weight: 600; font-size: 1.125rem;">KSh <%= schedule.totalAmount %></p>
                    </div>
                    <div>
                        <p class="text-meta">Total Interest (3%)</p>
                        <p style="font-weight: 600; font-size: 1.125rem;">KSh <%= schedule.totalInterest %></p>
                    </div>
                    <div>
                        <p class="text-meta">Monthly Payment</p>
                        <p style="font-weight: 600; font-size: 1.125rem;">KSh <%= schedule.schedule[0].payment %></p>
                    </div>
                </div>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Payment</th>
                        <th>Principal</th>
                        <th>Interest (3%)</th>
                    </tr>
                </thead>
                <tbody>
                    <% schedule.schedule.forEach(month => { %>
                    <tr>
                        <td>Month <%= month.month %></td>
                        <td>KSh <%= month.payment %></td>
                        <td>KSh <%= month.principal %></td>
                        <td>KSh <%= month.interest %></td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        <% } %>

        <!-- Repayment History -->
        <% if (repayments && repayments.length > 0) { %>
        <div class="card mb-6">
            <h3 class="small-title" style="margin-bottom: 1.5rem;">üí≥ Repayment History</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Reference</th>
                    </tr>
                </thead>
                <tbody>
                    <% repayments.forEach(payment => { %>
                    <tr>
                        <td><%= new Date(payment.created_at).toLocaleDateString() %></td>
                        <td>KSh <%= payment.amount.toLocaleString() %></td>
                        <td><%= payment.payment_method %></td>
                        <td><%= payment.transaction_ref %></td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        <% } %>

        <!-- Actions -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
            <a href="/loans/page" class="btn-secondary">Back to Loans</a>
            <% if (loan.status === 'active') { %>
            <a href="/loans/<%= loan.id %>/repay" class="btn-primary">Make Payment</a>
            <% } %>
        </div>
    </div>

    <%- include('../layouts/footer') %>
    <script>
        async function cancelLoan() {
            if (!confirm('Are you sure you want to cancel this loan request?')) {
                return;
            }

            try {
                const response = await fetch('/loans/<%= loan.id %>/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '<%= csrfToken %>'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Loan request cancelled successfully');
                    window.location.href = '/loans/page';
                } else {
                    alert('Error: ' + (data.error || 'Failed to cancel loan'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to cancel loan. Please try again.');
            }
        }
    </script>
</body>
</html>
