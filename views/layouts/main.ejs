<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | SACCO System</title>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body style="background: #FFFFFF; margin: 0; padding: 0;">
 
    <main>
        <%- body %>
    </main>

    <footer style="margin-top: 3rem; padding: 2rem 0; border-top: 1px solid #E5E5E5;">
        <p style="font-size: 0.75rem; color: #9CA3AF; text-align: center; text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">
            &copy; <%= new Date().getFullYear() %> SACCO System. All rights reserved.
        </p>
    </footer>

    <!-- Notifications Modal - Hidden by default -->
    <div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationsModalLabel">Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificationsContainer">
                    <p>Loading notifications...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // Show flash messages as toasts
        <% if (typeof success_msg !== 'undefined' && success_msg && success_msg.length > 0) { %>
            const successMsg = "<%= success_msg[0] %>";
            Toastify({
                text: successMsg,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: "linear-gradient(to right, #00b09b, #96c93d)",
                }
            }).showToast();
        <% } %>

        <% if (typeof error_msg !== 'undefined' && error_msg && error_msg.length > 0) { %>
            const errorMsg = "<%= error_msg[0] %>";
            Toastify({
                text: errorMsg,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                }
            }).showToast();
        <% } %>

        <% if (typeof error !== 'undefined' && error && error.length > 0) { %>
            const error = "<%= error[0] %>";
            Toastify({
                text: error,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                }
            }).showToast();
        <% } %>

        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('notificationsModal');
            const container = document.getElementById('notificationsContainer');
            const badge = document.getElementById('notificationsBadge');

            modal.addEventListener('show.bs.modal', async () => {
                container.innerHTML = '<p>Loading notifications...</p>';
                try {
                    const res = await fetch('/members/notifications');
                    const data = await res.json();

                    if (!data.notifications || data.notifications.length === 0) {
                        container.innerHTML = '<p>No new notifications.</p>';
                    } else {
                        container.innerHTML = '<ul class="list-group">' + 
                            data.notifications.map(n => 
                                `<li class="list-group-item ${n.read ? '' : 'fw-bold'}">
                                    ${n.message} <br>
                                    <small class="text-muted">${new Date(n.date).toLocaleString()}</small>
                                </li>`).join('') +
                            '</ul>';
                    }

                    if (badge) {
                        const unreadCount = data.notifications.filter(n => !n.read).length;
                        badge.textContent = unreadCount;
                    }

                } catch (err) {
                    console.error(err);
                    container.innerHTML = '<p>Error loading notifications.</p>';
                }
            });

            setInterval(async () => {
                try {
                    const res = await fetch('/members/notifications');
                    const data = await res.json();
                    if (badge) {
                        const unreadCount = data.notifications.filter(n => !n.read).length;
                        badge.textContent = unreadCount;
                    }
                } catch (err) { 
                    console.error(err); 
                }
            }, 30000);
        });
    </script>

</body>
</html>