<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= csrfToken %>">
    <title><%= title %> - SACCO Admin</title>
    <link rel="stylesheet" href="/css/design-system.css">
</head>
<body>


    <div class="container-xl">
        <!-- Page Header -->
        <div class="page-header">
            <div class="accent-line"></div>
            <h1 class="page-title">Review Document</h1>
            <p class="page-subtitle"><%= document.member_name %> - <%= document.document_type.replace('_', ' ') %></p>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <!-- Document Display -->
            <div class="card">
                <h2 class="section-title mb-6">Document Image</h2>

                <div style="background: #F5F5F5; padding: 2rem; text-align: center; border: 1px solid #E5E5E5;">
                    <% if (document.file_path.match(/\.(jpg|jpeg|png|gif)$/i)) { %>
                        <img src="/<%= document.file_path %>"
                             alt="<%= document.document_type %>"
                             style="max-width: 100%; height: auto; border: 1px solid #E5E5E5;">
                    <% } else if (document.file_path.match(/\.pdf$/i)) { %>
                        <iframe src="/<%= document.file_path %>"
                                style="width: 100%; height: 600px; border: 1px solid #E5E5E5;">
                        </iframe>
                    <% } else { %>
                        <p>Preview not available for this file type</p>
                        <a href="/<%= document.file_path %>" class="btn-primary" download>
                            Download Document
                        </a>
                    <% } %>
                </div>

                <div style="margin-top: 1rem; padding: 1rem; background: #FAFAFA; border: 1px solid #E5E5E5;">
                    <p class="text-meta">File Name</p>
                    <p style="font-weight: 600; margin-bottom: 0.5rem;"><%= document.file_name %></p>

                    <p class="text-meta">Uploaded</p>
                    <p style="font-weight: 600;"><%= new Date(document.uploaded_at).toLocaleString() %></p>
                </div>
            </div>

            <!-- Review Form -->
            <div class="card">
                <h2 class="section-title mb-6">Review Details</h2>

                <!-- Member Information -->
                <div style="padding: 1rem; background: #FAFAFA; border: 1px solid #E5E5E5; margin-bottom: 2rem;">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">Member Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <p class="text-meta">Full Name</p>
                            <p style="font-weight: 600;"><%= document.member_name %></p>
                        </div>
                        <div>
                            <p class="text-meta">Email</p>
                            <p style="font-weight: 600;"><%= document.member_email %></p>
                        </div>
                    </div>
                </div>

                <!-- Current Status -->
                <div style="margin-bottom: 2rem;">
                    <p class="text-meta">Current Status</p>
                    <p style="font-size: 1.25rem; font-weight: 600; margin-top: 0.5rem;">
                        <% if (document.status === 'approved') { %>
                            <span style="color: #10B981;">Approved</span>
                        <% } else if (document.status === 'in_review') { %>
                            <span style="color: #F59E0B;">In Review</span>
                        <% } else if (document.status === 'rejected') { %>
                            <span style="color: #EF4444;">Rejected</span>
                        <% } else { %>
                            <span style="color: #6B7280;">Pending</span>
                        <% } %>
                    </p>

                    <% if (document.reviewer_name) { %>
                        <p class="text-meta" style="margin-top: 0.5rem;">
                            Reviewed by <%= document.reviewer_name %> on <%= new Date(document.reviewed_at).toLocaleString() %>
                        </p>
                    <% } %>

                    <% if (document.rejection_reason) { %>
                        <div style="margin-top: 1rem; padding: 1rem; background: #FEE2E2; border: 1px solid #EF4444;">
                            <p class="text-meta" style="color: #991B1B;">Rejection Reason</p>
                            <p style="color: #991B1B; margin-top: 0.5rem;"><%= document.rejection_reason %></p>
                        </div>
                    <% } %>
                </div>

                <!-- Member's Other Documents -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">Other Documents</h3>
                    <% memberDocuments.forEach(doc => { %>
                        <% if (doc.id !== document.id) { %>
                            <div style="padding: 0.75rem; background: #FAFAFA; border: 1px solid #E5E5E5; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-weight: 600; text-transform: capitalize;">
                                            <%= doc.document_type.replace('_', ' ') %>
                                        </p>
                                        <p class="text-meta">
                                            Status:
                                            <% if (doc.status === 'approved') { %>
                                                <span style="color: #10B981;">Approved</span>
                                            <% } else if (doc.status === 'in_review') { %>
                                                <span style="color: #F59E0B;">In Review</span>
                                            <% } else if (doc.status === 'rejected') { %>
                                                <span style="color: #EF4444;">Rejected</span>
                                            <% } else { %>
                                                <span>Pending</span>
                                            <% } %>
                                        </p>
                                    </div>
                                    <a href="/admin/documents/<%= doc.id %>" class="btn-sm btn-secondary">View</a>
                                </div>
                            </div>
                        <% } %>
                    <% }) %>
                </div>

                <!-- Review Actions -->
                <form id="reviewForm">
                    <div class="form-group">
                        <label for="status">Update Status</label>
                        <select id="status" name="status" required>
                            <option value="">Select Status</option>
                            <option value="in_review" <%= document.status === 'in_review' ? 'selected' : '' %>>In Review</option>
                            <option value="approved" <%= document.status === 'approved' ? 'selected' : '' %>>Approved</option>
                            <option value="rejected" <%= document.status === 'rejected' ? 'selected' : '' %>>Rejected</option>
                        </select>
                    </div>

                    <div class="form-group" id="rejectionReasonGroup" style="display: none;">
                        <label for="rejectionReason">Rejection Reason</label>
                        <textarea id="rejectionReason"
                                  name="rejection_reason"
                                  rows="4"
                                  placeholder="Please provide a clear reason for rejection..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn-primary">Update Status</button>
                        <a href="/admin/documents" class="btn-secondary">Back to List</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('../layouts/footer') %>

    <script>
        // Get CSRF token from meta tag
        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        }

        const statusSelect = document.getElementById('status');
        const rejectionReasonGroup = document.getElementById('rejectionReasonGroup');
        const rejectionReasonInput = document.getElementById('rejectionReason');
        const reviewForm = document.getElementById('reviewForm');

        // Show/hide rejection reason field
        statusSelect.addEventListener('change', function() {
            if (this.value === 'rejected') {
                rejectionReasonGroup.style.display = 'block';
                rejectionReasonInput.required = true;
            } else {
                rejectionReasonGroup.style.display = 'none';
                rejectionReasonInput.required = false;
            }
        });

        // Trigger change event on page load
        statusSelect.dispatchEvent(new Event('change'));

        // Handle form submission
        reviewForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const status = statusSelect.value;
            const rejectionReason = rejectionReasonInput.value;

            if (!status) {
                alert('Please select a status');
                return;
            }

            if (status === 'rejected' && !rejectionReason.trim()) {
                alert('Please provide a rejection reason');
                return;
            }

            if (!confirm(`Are you sure you want to update this document status to ${status}?`)) {
                return;
            }

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';

            try {
                const response = await fetch('/admin/documents/<%= document.id %>/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status,
                        rejection_reason: rejectionReason || null,
                        _csrf: getCsrfToken()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update status'));
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Update Status';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to update status. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Status';
            }
        });
    </script>
</body>
</html>
