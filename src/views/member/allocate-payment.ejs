<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %> - SACCO System
    </title>
    <link rel="stylesheet" href="/css/output.css">
</head>

<body class="bg-gray-50">
    <%- include('../partials/header') %>

        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Allocate Your Payment</h1>

                <!-- Current Status Summary -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h2 class="font-semibold text-blue-900 mb-3">Your Current Status</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Active Loans</p>
                            <p class="font-bold text-gray-900">KES <%= summary.loan_balance.toLocaleString() %>
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-600">Total Shares</p>
                            <p class="font-bold text-gray-900">
                                <%= summary.total_shares %> shares
                            </p>
                            <p class="text-xs text-gray-500">KES <%= summary.share_value?.toLocaleString() || '0' %>
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-600">Share Status</p>
                            <% if (summary.has_minimum_shares) { %>
                                <p class="font-bold text-green-600">âœ“ Minimum Met</p>
                                <% } else { %>
                                    <p class="font-bold text-orange-600">
                                        <%= summary.shares_needed %> more needed
                                    </p>
                                    <% } %>
                        </div>
                        <div>
                            <p class="text-gray-600">Savings</p>
                            <p class="font-bold text-gray-900">KES <%= summary.personal_savings.toLocaleString() %>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Payment Allocation Form -->
                <form id="allocationForm" class="space-y-6">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                    <!-- Loan Repayment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Loan Repayment
                            <% if (summary.has_active_loans) { %>
                                <span class="text-red-600">(Outstanding: KES <%= summary.loan_balance.toLocaleString()
                                        %>)</span>
                                <% } %>
                        </label>
                        <input type="number" name="loan" id="loanAmount" min="0" step="0.01" value="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="0.00">
                    </div>

                    <!-- Welfare Contribution -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Welfare Contribution
                            <span class="text-gray-500">(Recommended: KES <%= paymentConfig.WELFARE_AMOUNT %>)</span>
                        </label>
                        <input type="number" name="welfare" id="welfareAmount" min="0" step="0.01"
                            value="<%= paymentConfig.WELFARE_AMOUNT %>"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="0.00">
                    </div>

                    <!-- Share Capital -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Share Capital
                            <span class="text-gray-500">(KES <%= paymentConfig.SHARE_PRICE %> per share)</span>
                            <% if (!summary.has_minimum_shares) { %>
                                <span class="text-orange-600">(Need <%= summary.shares_needed %> more shares)</span>
                                <% } %>
                        </label>
                        <input type="number" name="shares" id="sharesAmount" min="0"
                            step="<%= paymentConfig.SHARE_PRICE %>" value="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="0.00">
                        <p class="text-xs text-gray-500 mt-1">Must be multiples of KES <%=
                                paymentConfig.SHARE_PRICE.toLocaleString() %>
                        </p>
                    </div>

                    <!-- Personal Savings -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Personal Savings
                        </label>
                        <input type="number" name="savings" id="savingsAmount" min="0" step="0.01" value="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="0.00">
                    </div>

                    <!-- Total Display -->
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-gray-700">Total Amount:</span>
                            <span class="text-2xl font-bold text-blue-600" id="totalAmount">KES 0.00</span>
                        </div>
                    </div>

                    <!-- Phone Number -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            M-Pesa Phone Number
                        </label>
                        <input type="tel" name="phone_number" id="phoneNumber" required pattern="^254[0-9]{9}$"
                            placeholder="254712345678"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Format: 254XXXXXXXXX</p>
                    </div>

                    <!-- Error Messages -->
                    <div id="errorMessages" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                        <ul id="errorList" class="list-disc list-inside text-red-700 text-sm"></ul>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn"
                        class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Initiate Payment
                    </button>
                </form>
            </div>
        </div>

        <script>
            // Calculate total in real-time
            const inputs = ['loanAmount', 'welfareAmount', 'sharesAmount', 'savingsAmount'];
            const totalDisplay = document.getElementById('totalAmount');
            const errorMessages = document.getElementById('errorMessages');
            const errorList = document.getElementById('errorList');

            function calculateTotal() {
                let total = 0;
                inputs.forEach(id => {
                    const value = parseFloat(document.getElementById(id).value) || 0;
                    total += value;
                });
                totalDisplay.textContent = `KES ${total.toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                return total;
            }

            // Add event listeners
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculateTotal);
            });

            // Form submission
            document.getElementById('allocationForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);

                try {
                    const response = await fetch('/payment-allocation/initiate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Payment initiated! Please check your phone for the M-Pesa prompt.');
                        window.location.href = '/members/dashboard';
                    } else {
                        showErrors([result.error]);
                    }
                } catch (error) {
                    showErrors(['Failed to initiate payment. Please try again.']);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Initiate Payment';
                }
            });

            function showErrors(errors) {
                errorList.innerHTML = '';
                errors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    errorList.appendChild(li);
                });
                errorMessages.classList.remove('hidden');
            }

            // Initial calculation
            calculateTotal();
        </script>
</body>

</html>